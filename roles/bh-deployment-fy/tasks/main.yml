
- name: Resize /var for content
  sudo: yes
  lvol: vg=vg00 lv=var_lv size=32g
  notify:
    - resize xfs
    - remount xfs

- meta: flush_handlers

- name: Install mirror software
  sudo: yes
  yum: name={{ item }} state=present
  with_items:
    - httpd
    - rsync
    - createrepo
    - tftp
    - tftp-server
    - syslinux-tftpboot
    - ipxe-bootimgs

- name: Configure mirror paths
  sudo: yes
  action: file state=directory path={{ item }}
  with_items:
   - /var/lib/tftpboot/pxelinux.cfg/
   - /var/www/html/ks/
   - /var/www/html/pub/centos/{{ centos_version }}/os/x86_64/
   - /var/www/html/pub/centos/{{ centos_version }}/updates/x86_64/
   - /var/www/html/pub/centos/{{ centos_version }}/extras/x86_64/
   - /var/www/html/pub/epel/{{ centos_version }}/x86_64/

- name: kickstart httpd started
  sudo: yes
  action: service name=httpd.service enabled=yes state=started

- name: kickstart tftpd started
  sudo: yes
  action: service name=tftp.socket enabled=yes state=started

- name: config mirror firewalld
  sudo: yes
  firewalld: service={{ item }} zone=internal permanent=yes state=enabled immediate=yes
  with_items:
    - http
    - tftp

- name: sync install mirror
  sudo: yes
  action: shell rsync -az --exclude='*.iso' rsync://{{ centos_mirror }}/centos/{{ centos_version }}/os/x86_64/ /var/www/html/pub/centos/{{ centos_version }}/os/x86_64/
  delegate_to: "{{ item }}"
  with_items: groups.deployment_servers

- name: sync update mirror
  sudo: yes
  action: shell rsync -az rsync://{{ centos_mirror }}/centos/{{ centos_version }}/updates/x86_64/ /var/www/html/pub/centos/{{ centos_version }}/updates/x86_64/
  delegate_to: "{{ item }}"
  with_items: groups.deployment_servers

- name: sync update mirror
  sudo: yes
  action: shell rsync -az rsync://{{ centos_mirror }}/centos/{{ centos_version }}/extras/x86_64/ /var/www/html/pub/centos/{{ centos_version }}/extras/x86_64/
  delegate_to: "{{ item }}"
  with_items: groups.deployment_servers

- name: sync epel mirror
  sudo: yes
  action: shell rsync -az --exclude='debug/*' rsync://{{ centos_mirror }}/epel/{{ centos_version }}/x86_64/ /var/www/html/pub/epel/{{ centos_version }}/x86_64/
  delegate_to: "{{ item }}"
  with_items: groups.deployment_servers

